FROM migrate/migrate AS base

WORKDIR /app

ARG POSTGRES_USER
ENV POSTGRES_USER=${POSTGRES_USER}

ARG POSTGRES_PASSWORD
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

ARG POSTGRES_HOST
ENV POSTGRES_HOST=${POSTGRES_HOST}

ARG POSTGRES_DATABASE
ENV POSTGRES_DATABASE=${POSTGRES_DATABASE}

ARG MIGRATE_COMMAND
ENV MIGRATE_COMMAND=${MIGRATE_COMMAND}

ARG MIGRATE_NUMBER
ENV MIGRATE_NUMBER=${MIGRATE_NUMBER}

COPY . /app

FROM base as migrate

ENTRYPOINT migrate -path ./changes -database postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST:5432/$POSTGRES_DATABASE?sslmode=disable $MIGRATE_COMMAND $MIGRATE_NUMBER
